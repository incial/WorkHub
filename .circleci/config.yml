version: 2.1

jobs:
  build-and-push:
    docker:
      - image: cimg/openjdk:17.0
    steps:
      - checkout

      # -----------------------------
      # Build Spring Boot JAR
      # -----------------------------
      - run:
          name: Build Backend JAR
          command: |
            cd server
            mvn clean package -DskipTests

      # -----------------------------
      # Enable Docker daemon
      # -----------------------------
      - setup_remote_docker:
          docker_layer_caching: true

      # -----------------------------
      # Install AWS CLI
      # -----------------------------
      - run:
          name: Install AWS CLI
          command: |
            sudo apt-get update
            sudo apt-get install -y awscli

      # -----------------------------
      # Login to AWS ECR
      # -----------------------------
      - run:
          name: Login to Amazon ECR
          command: |
            aws ecr get-login-password --region $AWS_REGION | \
            docker login \
              --username AWS \
              --password-stdin \
              $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      # -----------------------------
      # Build Docker image
      # -----------------------------
      - run:
          name: Build Docker image
          command: |
            cd server
            docker build -t $ECR_REPO_NAME:latest .

      # -----------------------------
      # Tag Docker image
      # -----------------------------
      - run:
          name: Tag Docker image
          command: |
            docker tag \
              $ECR_REPO_NAME:latest \
              $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO_NAME:latest

      # -----------------------------
      # Push Docker image to ECR
      # -----------------------------
      - run:
          name: Push Docker image to ECR
          command: |
            docker push \
              $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO_NAME:latest

workflows:
  build:
    jobs:
      - build-and-push
