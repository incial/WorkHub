version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.1.0

jobs:
  build-and-push:
    docker:
      - image: cimg/openjdk:17.0
    steps:
      - checkout

      # Build Spring Boot JAR
      - run:
          name: Build JAR
          command: |
            mvn clean package -DskipTests

      # Enable Docker
      - setup_remote_docker:
          docker_layer_caching: true

      # Configure AWS CLI
      - aws-cli/setup:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          aws-region: AWS_REGION

      # Login to Amazon ECR
      - run:
          name: Login to ECR
          command: |
            aws ecr get-login-password --region $AWS_REGION |
            docker login \
              --username AWS \
              --password-stdin \
              $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

      # Build Docker image
      - run:
          name: Build Docker image
          command: |
            docker build -t $ECR_REPO_NAME:latest .

      # Tag Docker image
      - run:
          name: Tag Docker image
          command: |
            docker tag \
              $ECR_REPO_NAME:latest \
              $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO_NAME:latest

      # Push Docker image
      - run:
          name: Push Docker image to ECR
          command: |
            docker push \
              $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO_NAME:latest

workflows:
  build:
    jobs:
      - build-and-push
